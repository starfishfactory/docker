#!/bin/bash

# /pr 커맨드 - GitHub PR 생성 도구
# 사용법: ./pr [starfish|euzene_yanolja]

# 사용자별 GitHub 토큰 설정 (환경 변수에서 읽기)
declare -A TOKENS
TOKENS["starfish"]="${GITHUB_TOKEN_STARFISH:-}"
TOKENS["euzene_yanolja"]="${GITHUB_TOKEN_EUZENE:-}"

# 인자 검증
if [ $# -ne 1 ]; then
    echo "❌ 사용법: ./pr [starfish|euzene_yanolja]"
    exit 1
fi

USER=$1

# 허용된 사용자인지 확인
if [[ ! "${TOKENS[$USER]+isset}" ]]; then
    echo "❌ 허용되지 않은 사용자: $USER"
    echo "✅ 허용된 사용자: starfish, euzene_yanolja"
    exit 1
fi

# 현재 브랜치 확인
CURRENT_BRANCH=$(git branch --show-current)
if [ -z "$CURRENT_BRANCH" ]; then
    echo "❌ 현재 브랜치를 확인할 수 없습니다."
    exit 1
fi

# 최근 커밋 메시지에서 깃모지 타입 추출
LAST_COMMIT_MSG=$(git log -1 --pretty=%s)
GITMOJI_TYPE=$(echo "$LAST_COMMIT_MSG" | grep -oE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)' || echo "feat")

# 깃모지 매핑
declare -A GITMOJI
GITMOJI["feat"]="✨"
GITMOJI["fix"]="🐛"
GITMOJI["docs"]="📝"
GITMOJI["style"]="💄"
GITMOJI["refactor"]="♻️"
GITMOJI["test"]="✅"
GITMOJI["chore"]="🔧"
GITMOJI["perf"]="⚡"
GITMOJI["ci"]="👷"
GITMOJI["build"]="📦"
GITMOJI["revert"]="⏪"

# 기본 깃모지
EMOJI=${GITMOJI[$GITMOJI_TYPE]:-"✨"}

# PR 제목 생성 (최근 커밋 메시지 기반)
PR_TITLE="$EMOJI $LAST_COMMIT_MSG"

# PR 본문 템플릿
PR_BODY="## 📋 개요
이 PR의 주요 변경사항을 간단히 설명합니다.

## 📝 변경사항
- 주요 변경 내용 1
- 주요 변경 내용 2

## ✅ 체크리스트
- [ ] 코드 리뷰 요청
- [ ] 테스트 완료
- [ ] 문서 업데이트 (필요시)

🤖 Generated with Claude Code"

# GitHub CLI를 사용하여 PR 생성
echo "🚀 PR을 생성중입니다..."
echo "👤 사용자: $USER"
echo "🌿 브랜치: $CURRENT_BRANCH"

GH_TOKEN="${TOKENS[$USER]}" gh pr create \
    --draft \
    --title "$PR_TITLE" \
    --body "$PR_BODY" \
    --base main

if [ $? -eq 0 ]; then
    echo "✅ PR이 성공적으로 생성되었습니다!"
else
    echo "❌ PR 생성에 실패했습니다."
    exit 1
fi